name: Ludo Game Socket CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H 20.169.153.179 >> ~/.ssh/known_hosts
          
          # Verify connection
          ssh -o IdentitiesOnly=yes -i ~/.ssh/deploy_key ludo@20.169.153.179 "echo 'SSH connection successful'"
          
      - name: Deploy to production
        run: |
          # Create archive with ignore-failed-read to prevent errors
          tar --exclude='.git' --exclude='node_modules' --exclude='.github' \
              --ignore-failed-read -czf deploy.tar.gz . || true
          
          # Transfer files
          scp -o IdentitiesOnly=yes -i ~/.ssh/deploy_key deploy.tar.gz ludo@20.169.153.179:/tmp/
          
          # Execute deployment commands
          ssh -o IdentitiesOnly=yes -i ~/.ssh/deploy_key ludo@20.169.153.179 << 'EOF'
            set -ex
            
            # Create deployment directory
            sudo mkdir -p /var/opt/sockets/backups
            
            # Backup existing deployment
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            sudo tar -czf /var/opt/sockets/backups/backup_${TIMESTAMP}.tar.gz -C /var/opt/sockets . 2>/dev/null || true
            
            # Extract new files
            sudo mkdir -p /tmp/deployment
            sudo tar -xzf /tmp/deploy.tar.gz -C /tmp/deployment
            
            # Preserve environment file if exists
            if [ -f "/var/opt/sockets/.env" ]; then
              sudo cp /var/opt/sockets/.env /tmp/deployment/.env
            fi
            
            # Sync files (excluding backups)
            sudo rsync -a --delete --exclude='backups' /tmp/deployment/ /var/opt/sockets/
            
            # Set permissions
            sudo chown -R www-data:www-data /var/opt/sockets
            sudo chmod -R 755 /var/opt/sockets
            
            # Install dependencies
            cd /var/opt/sockets
            sudo composer install --no-dev --optimize-autoloader
            
            # Restart services
            sudo supervisorctl update
            if sudo supervisorctl status | grep -q 'gamesocket'; then
              sudo supervisorctl restart gamesocket
            else
              sudo supervisorctl restart all
            fi
            
            # Cleanup
            sudo rm -rf /tmp/deployment /tmp/deploy.tar.gz
            echo "Deployment completed successfully"
          EOF